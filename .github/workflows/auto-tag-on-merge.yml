name: Auto Tag on PR Merge

on:
  pull_request:
    types: [closed]

jobs:
  create-tag:
    name: Create Tag on Merge
    # Only run if the PR was actually merged (not just closed)
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Generate tag name
        id: generate_tag
        run: |
          # Generate timestamp in format YYYYMMDD-HHMMSS
          TIMESTAMP=$(date -u +%Y%m%d-%H%M%S)
          PR_NUMBER=${{ github.event.pull_request.number }}
          TAG_NAME="v${TIMESTAMP}-pr${PR_NUMBER}"
          echo "tag_name=${TAG_NAME}" >> $GITHUB_OUTPUT
          echo "Generated tag: ${TAG_NAME}"
      
      - name: Create and push tag via API
        env:
          TAG_NAME: ${{ steps.generate_tag.outputs.tag_name }}
          GITHUB_TOKEN: ${{ secrets.REPO_PAT }}
        run: |
          set -e  # Exit on any error
          
          # Get the commit SHA for the merge commit
          COMMIT_SHA="${{ github.event.pull_request.merge_commit_sha }}"
          
          # Create tag via GitHub API using REPO_PAT
          curl -X POST \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/repos/${{ github.repository }}/git/refs" \
            -d "{\"ref\":\"refs/tags/${TAG_NAME}\",\"sha\":\"${COMMIT_SHA}\"}" \
            --fail-with-body
          
          echo "Tag ${TAG_NAME} created successfully via API"
      
      - name: Trigger release workflow
        env:
          TAG_NAME: ${{ steps.generate_tag.outputs.tag_name }}
          GITHUB_TOKEN: ${{ secrets.REPO_PAT }}
        run: |
          set -e  # Exit on any error
          
          # Trigger the release workflow via API using REPO_PAT
          curl -X POST \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/repos/${{ github.repository }}/actions/workflows/release.yml/dispatches" \
            -d "{\"ref\":\"${TAG_NAME}\"}" \
            --fail-with-body
          
          echo "Release workflow triggered for tag ${TAG_NAME}"
