name: Auto Tag on PR Merge

on:
  pull_request:
    types: [closed]

jobs:
  create-tag:
    name: Create Tag on Merge
    # Only run if the PR was actually merged (not just closed)
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Generate tag name
        id: generate_tag
        run: |
          # Generate timestamp in format YYYYMMDD-HHMMSS
          TIMESTAMP=$(date -u +%Y%m%d-%H%M%S)
          PR_NUMBER=${{ github.event.pull_request.number }}
          TAG_NAME="v${TIMESTAMP}-pr${PR_NUMBER}"
          echo "tag_name=${TAG_NAME}" >> $GITHUB_OUTPUT
          echo "Generated tag: ${TAG_NAME}"
      
      - name: Create and push tag
        env:
          TAG_NAME: ${{ steps.generate_tag.outputs.tag_name }}
          GITHUB_TOKEN: ${{ secrets.REPO_PAT }}
        run: |
          set -e  # Exit on any error
          
          # Get the commit SHA for the merge commit
          COMMIT_SHA="${{ github.event.pull_request.merge_commit_sha }}"
          
          echo "Creating tag ${TAG_NAME} for commit ${COMMIT_SHA}"
          
          # Configure git
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"
          
          # Create the tag locally
          git tag "${TAG_NAME}" "${COMMIT_SHA}"
          echo "✓ Tag ${TAG_NAME} created locally"
          
          # Configure remote URL with authentication token
          git remote set-url origin "https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git"
          
          # Push the tag to remote (this will automatically trigger the release workflow via push event)
          git push origin "${TAG_NAME}" || {
            echo "✗ Failed to push tag"
            echo "Please check:"
            echo "  1. REPO_PAT secret exists and has 'repo' scope"
            echo "  2. REPO_PAT is authorized for SSO if required"
            echo "  3. Token has workflow permissions"
            exit 1
          }
          
          echo "✓ Tag pushed successfully - release workflow will trigger automatically on push event"
